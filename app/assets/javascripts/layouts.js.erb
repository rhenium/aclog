$(function() {
    $("#user-jump-dropdown .dropdown-toggle").click(function() {
        setTimeout(function() { $("#user-jump-dropdown input").focus(); }, 0);
    });

    var previousText = "";
    $("#user-jump-dropdown input").on("keyup", function() {
        if ($(this).val() != previousText) {
            previousText = $(this).val();
            $("#user-jump-dropdown .user-jump-suggestion").remove();

            if (previousText.length > 0) {
                $.getJSON("/i/user_jump_suggest.json", { head: previousText }, function(json) {
                    var menu = $("#user-jump-dropdown .dropdown-menu");
                    json.forEach(function(s) {
                        var img = $("<img />").addClass("twitter-icon").attr("src", s.profile_image_url).attr("alt", "@" + s.screen_name);
                        img.on("error", function() { this.src = '<%= image_path("profile_image_missing.png") %>'; });

                        menu.append($("<li />").addClass("user-jump-suggestion")
                            .append($("<a />").attr("href", "/" + s.screen_name).attr("title", s.name + " (@" + s.screen_name + ")")
                                .append(img)
                                .append($("<span />").text("@" + s.screen_name))));
                    });
                });
            }
        }
    });
    $("#user-jump-dropdown form").on("submit", function() {
        window.location = "/" + $("input", this).val();
        return false;
    });

    $("img.twitter-icon").on("error", function() { this.src = '<%= image_path("profile_image_missing.png") %>'; });
});
