//= require jquery
//= require jquery_ujs
//= require bootstrap/dropdown
//= require twitter-text-1.11.0
//= require superagent-1.2.0
//= require vue-0.12.8-master

//= require init
//= require_tree ./shared
//= require_tree ./controllers

$(function() {
  var ac = Views[Helpers.controller()];
  if (ac) {
    var spe = ac[Helpers.action()];
    if (spe) {
      spe();
    } else {
      ac._();
    }
  }
  Helpers.parts().forEach(function(par) {
    var base = Shared[par];
    if (base) { base(); }
  });
});

$(function() {
  var vm = new Vue({
    el: "#user-jump-dropdown",
    data: {
      users: [],
      enteredUserName: "",
      loading: false
    },
    methods: {
      failProfileImage: function(e) {
        e.target.src = '<%= image_path("profile_image_missing.png") %>';
      },
      focus: function() {
        setTimeout(function() { vm.$$.input.focus(); }, 0);
      },
      submit: function(e) {
        e.preventDefault();
        window.location = "/" + this.enteredUserName;
      },
    },
  });

  var currentReq = null;
  vm.$watch("enteredUserName", function(newVal, oldVal) {
    if (newVal.length == 0 || newVal === oldVal) { return; }
    if (vm.loading) { currentReq.abort(); }
    vm.users = [];
    vm.loading = true;
    currentReq = superagent
      .get("/i/api/users/suggest_screen_name.json")
      .query({ head: newVal })
      .accept("json")
      .end(function (err, res) {
        vm.users = res.body;
        vm.loading = false;
      });
  });
});
